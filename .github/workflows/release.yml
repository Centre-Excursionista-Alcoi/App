name: Release Binaries

on:
  release:
    types:
      - released

jobs:
  update-version-name:
    name: Update version name
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Update version name
        run: python ./scripts/updateVersionName.py --name=${{ github.event.release.name }}

      - name: Increase version code
        id: increase_version_code
        run: python ./scripts/increaseVersionCode.py

      - name: Commit modified version code file
        id: commit_version_code
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'Updated Version'
          file_pattern: 'version.properties composeApp/composeApp.podspec iosApp/iosApp.xcodeproj/project.pbxproj iosApp/iosApp/Info.plist'
          branch: master

  shared-tests:
    name: Run shared tests
    runs-on: ubuntu-latest

    needs: [ update-version-name ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: '21'
          java-package: jdk
          cache: 'gradle'

      - name: Run Shared Tests
        id: shared_tests
        run: ./gradlew :shared:check

      - name: Upload test results (on failure)
        if: ${{ steps.shared_tests.outcome == 'failure' }}
        uses: actions/upload-artifact@v6
        with:
          name: shared-test-results
          retention-days: 3
          path: |
            shared/build/test-results
            shared/build/reports/tests

  app-tests:
    name: Run app tests
    runs-on: ubuntu-latest

    needs: [ update-version-name ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: '21'
          java-package: jdk
          cache: 'gradle'

      - name: Run App Tests
        id: app_tests
        run: ./gradlew :composeApp:check

      - name: Decode google-services.json
        run: |
          echo ${{ secrets.GOOGLE_SERVICES_BASE64 }} > google-services.txt
          base64 --decode google-services.txt > android/google-services.json
      - name: Verify google-services.json integrity
        env:
          KEYSTORE_SHA256: 231998efc417aa76bf3de171964df690f52b830b6489b5bb882a1156237e742e
        run: |
          cd android
          echo "${{ env.KEYSTORE_SHA256 }} google-services.json" | sha256sum --check --status || exit 1

      - name: Upload test results (on failure)
        if: ${{ steps.app_tests.outcome == 'failure' }}
        uses: actions/upload-artifact@v6
        with:
          name: app-test-results
          retention-days: 3
          path: |
            composeApp/build/test-results
            composeApp/build/reports/tests

  build-android:
    name: Build for Android
    runs-on: ubuntu-latest

    needs: [shared-tests, app-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: '21'
          java-package: jdk
          cache: 'gradle'

      # Refresh the version name again just in case
      - name: Update version name
        run: python ./scripts/updateVersionName.py --name=${{ github.event.release.name }}

      - name: Determine In-App Update Priority
        id: determine_priority
        uses: actions/github-script@v8
        with:
          script: |
            let priority = 2;
            const currentVersion = context.payload.release.name;
            const currentTag = context.payload.release.tag_name;
            
            console.log(`Current Version Name: ${currentVersion}`);
            
            // 1. Check Version Increment (Major vs Minor)
            try {
              // Fetch recent releases to find the previous one
              const releases = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 10
              });
            
              // Filter out the current release and any drafts/prereleases to find the "previous" stable release
              const sortedReleases = releases.data
                .filter(r => !r.draft && !r.prerelease && r.tag_name !== currentTag)
                .sort((a, b) => new Date(b.published_at) - new Date(a.published_at));
            
              if (sortedReleases.length > 0) {
                const previousVersion = sortedReleases[0].name;
                console.log(`Previous Version: ${previousVersion}`);
            
                // Simple regex to extract Major.Minor
                const versionRegex = /^v?(\d+)\.(\d+)/;
                const currentMatch = currentVersion.match(versionRegex);
                const prevMatch = previousVersion.match(versionRegex);
            
                if (currentMatch && prevMatch) {
                  const currMajor = parseInt(currentMatch[1]);
                  const currMinor = parseInt(currentMatch[2]);
                  const prevMajor = parseInt(prevMatch[1]);
                  const prevMinor = parseInt(prevMatch[2]);
            
                  if (currMajor > prevMajor) {
                    priority = 4;
                    console.log("Major version increase detected. Setting priority to 4.");
                  } else if (currMinor > prevMinor) {
                    priority = 3;
                    console.log("Minor version increase detected. Setting priority to 3.");
                  }
                }
              } else {
                console.log("No previous release found to compare versions.");
              }
            } catch (err) {
              console.log("Error checking version history: " + err);
            }
            
            // 2. Check PR Labels (Only if priority is not already maxed out at 4)
            if (priority < 4) {
              try {
                // Get PRs associated with the release commit/tag
                const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: context.sha,
                });
            
                const highPriorityLabels = ['migration', 'important', 'security'];
            
                for (const pr of prs) {
                  const labels = pr.labels.map(l => l.name);
                  console.log(`Checking PR #${pr.number} labels: ${labels.join(', ')}`);
            
                  if (labels.some(l => highPriorityLabels.includes(l))) {
                    priority = 4;
                    console.log("High priority label found. Elevating priority to 4.");
                    break; // Efficiency: Don't check rest if max priority reached
                  } else if (labels.includes('app')) {
                    // Only upgrade to 3 if we are at 2. If we are already at 3 (due to minor version), stay at 3.
                    if (priority < 3) {
                      priority = 3;
                      console.log("'app' label found. Elevating priority to 3.");
                    }
                  }
                }
              } catch (err) {
                console.log("Error checking PR labels: " + err);
              }
            }
            
            console.log(`Final Calculated Priority: ${priority}`);
            core.setOutput('priority', priority);

      - name: Clean quote backslashes
        id: clean_backslash
        run: bash ./scripts/clean-backslash.sh

      - name: Decode Keystore
        run: |
          echo ${{ secrets.ANDROID_KEYSTORE_BASE64 }} > keystore.txt
          base64 --decode keystore.txt > keystore.jks
      - name: Verify Keystore integrity
        env:
          KEYSTORE_SHA256: 6268f9f99a68ab7903a342290ff1762c5ffdebd0fa467d3176c6dac2e0cdde7f
        run: |
          echo "${{ env.KEYSTORE_SHA256 }} keystore.jks" | sha256sum --check --status || exit 1
      - name: Verify Keystore contents
        run: |
          keytool -list -v -keystore keystore.jks -storepass ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

      - name: Decode google-services.json
        run: |
          echo ${{ secrets.GOOGLE_SERVICES_BASE64 }} > google-services.txt
          base64 --decode google-services.txt > android/google-services.json
      - name: Verify google-services.json integrity
        env:
          KEYSTORE_SHA256: 231998efc417aa76bf3de171964df690f52b830b6489b5bb882a1156237e742e
        run: |
          cd android
          echo "${{ env.KEYSTORE_SHA256 }} google-services.json" | sha256sum --check --status || exit 1

      # Set up Sentry UUIDs and create properties file
      - name: Sentry - Generate UUIDs
        id: uuids
        run: |
          echo "source_uuid=$(uuidgen)" >> $GITHUB_OUTPUT
          echo "proguard_uuid=$(uuidgen)" >> $GITHUB_OUTPUT
      - name: Sentry - Create Properties File
        run: |
          # Define the target path
          ASSETS_DIR="composeApp/src/androidMain/assets"
          mkdir -p $ASSETS_DIR
          
          # Write the properties file
          echo "io.sentry.bundle-ids=${{ steps.uuids.outputs.source_uuid }}" > $ASSETS_DIR/sentry-debug-meta.properties
          echo "io.sentry.ProguardUuids=${{ steps.uuids.outputs.proguard_uuid }}" >> $ASSETS_DIR/sentry-debug-meta.properties
          
          cat $ASSETS_DIR/sentry-debug-meta.properties

      - name: Build AAB
        id: build_aab
        env:
          KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEYSTORE_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          PRODUCTION: true
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: ./gradlew :android:bundleRelease :android:assembleRelease

      - name: Sentry - Install CLI
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
      - name: Sentry - Upload Source Bundle
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          # Simulate Android source structure for Sentry
          mkdir -p build/sentry-sources
          cp -R composeApp/src/commonMain/kotlin/. build/sentry-sources/
          cp -R composeApp/src/androidMain/kotlin/. build/sentry-sources/

          sentry-cli debug-files bundle-jvm --output bundle --debug-id ${{ steps.uuids.outputs.source_uuid }} build/sentry-sources/ --org ${{ secrets.SENTRY_ORG }} --project ${{ secrets.SENTRY_PROJECT }}
          sentry-cli debug-files upload --type jvm bundle/${{ steps.uuids.outputs.source_uuid }}.zip --org ${{ secrets.SENTRY_ORG }} --project ${{ secrets.SENTRY_PROJECT }}
      - name: Sentry - Upload ProGuard Mapping
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          sentry-cli upload-proguard \
            --uuid ${{ steps.uuids.outputs.proguard_uuid }} \
            --org ${{ secrets.SENTRY_ORG }} \
            --project ${{ secrets.SENTRY_PROJECT }} \
            android/build/outputs/mapping/release/mapping.txt

      - name: Release AAB & APK
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ./android/build/outputs/**/*.apk

      - name: Upload to Play Store
        id: upload_play_store
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_GOOGLE_CLOUD_JSON }}
          packageName: org.centrexcursionistalcoi.app
          releaseFiles: ./android/build/outputs/bundle/release/android-release.aab
          track: "beta"
          # Priority is dynamically set by the previous script step
          inAppUpdatePriority: ${{ steps.determine_priority.outputs.priority }}
          status: completed

  sentry-android:
    name: Release Android to Sentry
    runs-on: ubuntu-latest

    needs: build-android

    steps:
      - uses: actions/checkout@v6
      - name: Create Sentry release - Android
        uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: app-android
        with:
          environment: production
          version: ${{ github.event.release.name }}

  build-ios:
    name: Build for iOS
    runs-on: macos-26

    needs: [shared-tests, app-tests]

    if: false  # Temporarily disabled due to issues with GoogleService-Info.plist not being found on runtime

    steps:
      - uses: actions/checkout@v6

      # --- Setup Environment ---
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: '21'
          java-package: jdk
          cache: 'gradle'

      - name: Cache CocoaPods
        uses: actions/cache@v5
        with:
          path: iosApp/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('iosApp/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      # Refresh the version name again just in case
      - name: Update version name
        run: python ./scripts/updateVersionName.py --name=${{ github.event.release.name }}

      # --- Install Signing Assets ---
      - name: Install Certificate and Profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security list-keychains -d user -s $KEYCHAIN_PATH $(security list-keychains -d user | sed -e 's/^[[:space:]]*"//' -e 's/"[[:space:]]*$//')
          
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Create GoogleService.plist
        env:
          GOOGLE_SERVICE_PLIST_BASE64: ${{ secrets.GOOGLE_SERVICE_PLIST_BASE64 }}
        run: |
          rm iosApp/iosApp/GoogleService-Info.plist
          printf '%s\n' "$GOOGLE_SERVICE_PLIST_BASE64" | base64 --decode > iosApp/iosApp/GoogleService-Info.plist
      - name: Verify GoogleService-Info.plist integrity
        env:
          GOOGLE_SERVICE_INFO_SHA256: 2dffdbd64e2c8d027a2b3f51199afa60f1a6414e5bac4ead873674f6490ddcd6
        run: |
          cd iosApp/iosApp
          echo "${{ env.GOOGLE_SERVICE_INFO_SHA256 }}  GoogleService-Info.plist" | shasum -a 256 -c -

      - name: Install CocoaPods
        run: |
          ./gradlew :composeApp:generateDummyFramework
          cd iosApp
          pod install --repo-update

      - name: Archive iOS App
        run: |
          xcodebuild -workspace iosApp/iosApp.xcworkspace \
            -scheme iosApp \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $PWD/build/iosApp.xcarchive \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="CEA App" \
            DEVELOPMENT_TEAM="UQSVPP37UL" \
            clean archive

      - name: Generate ExportOptions.plist
        env:
          TEAM_ID: "UQSVPP37UL"
          BUNDLE_ID: "org.centrexcursionistalcoi.app"
          PROFILE_NAME: "CEA App"
        run: |
          cat <<EOF > iosApp/ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
          
              <key>teamID</key>
              <string>$TEAM_ID</string>
          
              <key>signingStyle</key>
              <string>manual</string>
          
              <key>provisioningProfiles</key>
              <dict>
                  <key>$BUNDLE_ID</key>
                  <string>$PROFILE_NAME</string>
              </dict>
          
              <key>stripSwiftSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/iosApp.xcarchive \
            -exportOptionsPlist iosApp/ExportOptions.plist \
            -exportPath $PWD/build/output

      - name: IPA Artifact
        id: aab_artifact
        uses: actions/upload-artifact@v6
        with:
          name: IPA Artifact
          path: build/output/*.ipa

      # --- Upload to App Store Connect ---
      - name: Upload to App Store Connect
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # 1. Debug: Print what files were actually exported
          echo "Listing exported files:"
          ls -R build/output

          # 2. Find the IPA file path dynamically
          # This looks inside build/output for any file ending in .ipa
          IPA_PATH=$(find build/output -name "*.ipa" | head -n 1)

          if [ -z "$IPA_PATH" ]; then
            echo "Error: No IPA file found in build/output"
            exit 1
          fi

          echo "Found IPA at: $IPA_PATH"
          
          # 1. Create the AuthKey file from the Secret
          mkdir -p ~/.private_keys
          echo -n "$API_KEY_BASE64" | base64 --decode -o ~/.private_keys/AuthKey_$API_KEY_ID.p8
          
          # 2. Validate and Upload
          # 'altool' is the standard command line tool for this provided by Xcode.
          echo "Uploading to App Store Connect..."
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID"

      - name: Sentry - Upload iOS Debug Files (dSYMs & Source)
        run: |
          curl -sL https://sentry.io/get-cli/ | bash
          
          DSYM_PATH="$PWD/iosApp/build/iosApp.xcarchive/dSYMs"
          
          sentry-cli debug-files upload \
            --include-sources \
            --auth-token ${{ secrets.SENTRY_AUTH_TOKEN }} \
            --org ${{ secrets.SENTRY_ORG }} \
            --project ${{ secrets.SENTRY_PROJECT }} \
            "$DSYM_PATH"

  sentry-ios:
    name: Release iOS to Sentry
    runs-on: ubuntu-latest

    needs: build-ios

    steps:
      - uses: actions/checkout@v6
      - name: Create Sentry release - iOS
        uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: app-ios
        with:
          environment: production
          version: ${{ github.event.release.name }}

  build-desktop:
    name: Build for Desktop
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-22.04, windows-latest]

    needs: [shared-tests, app-tests]

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: '21'
          java-package: jdk
          cache: 'gradle'

      # Refresh the version name again just in case
      - name: Update version name
        run: python ./scripts/updateVersionName.py --name=${{ github.event.release.name }}
      - name: Clean quote backslashes
        id: clean_backslash
        run: bash ./scripts/clean-backslash.sh


      - name: Write local.properties
        run: echo '${{ secrets.LOCAL_PROPERTIES }}' > local.properties

      - name: Build
        env:
          PRODUCTION: true
        run: ./gradlew :composeApp:packageReleaseDistributionForCurrentOS

      - name: Rename deb
        if: startsWith(matrix.os, 'ubuntu')
        run: mv composeApp/build/compose/binaries/main-release/deb/*.deb composeApp/build/compose/binaries/main-release/deb/cea-app_${{ matrix.os }}_amd64.deb

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            composeApp/build/compose/binaries/main-release/**/*.exe
            composeApp/build/compose/binaries/main-release/**/*.deb

  sentry-desktop:
    name: Release Desktop to Sentry
    runs-on: ubuntu-latest

    needs: build-desktop

    steps:
      - uses: actions/checkout@v6
      - name: Create Sentry release - Desktop
        uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: app-desktop
        with:
          environment: production
          version: ${{ github.event.release.name }}

  server-tests:
    name: Run server tests
    runs-on: ubuntu-latest

    needs: [ update-version-name ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: '21'
          java-package: jdk
          cache: 'gradle'

      - name: Run Server Tests
        id: server_tests
        run: ./gradlew :server:check

      - name: Upload test results (on failure)
        if: ${{ steps.server_tests.outcome == 'failure' }}
        uses: actions/upload-artifact@v6
        with:
          name: server-test-results
          path: |
            server/build/test-results
            server/build/reports/tests

  release-server:
    name: Build and Publish Server Docker image
    runs-on: ubuntu-latest

    needs: [server-tests, shared-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      - name: Build and push development
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: |
            arnyminerz/cea-app:latest
            arnyminerz/cea-app:${{ github.event.release.name }}
          file: server/Dockerfile
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}
      - name: Update Release description
        # https://img.shields.io/docker/image-size/arnyminerz/cea-app/latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SUFFIX: |
            
            [![Docker Hub badge](https://img.shields.io/docker/image-size/arnyminerz/cea-app/${{ github.event.release.name }})](https://hub.docker.com/repository/docker/arnyminerz/cea-app/tags/${{ github.event.release.name }}/)
        run: |
          # Get the release data for this tag
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/${{ github.event.release.tag_name }} --jq '.id')
          
          # Get current release body
          BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body')
          
          # Append your suffix
          NEW_BODY="${BODY} <br/>${SUFFIX}"
          
          # Update the release with new body text
          gh api \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            repos/${{ github.repository }}/releases/$RELEASE_ID \
            -f body="$NEW_BODY"
  sentry-server:
    name: Release Server to Sentry
    runs-on: ubuntu-latest

    needs: release-server

    steps:
      - uses: actions/checkout@v6
      - name: Create Sentry release - Server
        uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: server
        with:
          environment: production
          version: ${{ github.event.release.name }}
